<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTT System - Hart's Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        fantasy: ['Cinzel', 'serif'],
                        body: ['Sarabun', 'sans-serif'],
                    },
                    colors: {
                        dnd: {
                            bg: '#0c0a09',     /* Stone 950 */
                            dark: '#1c1917',   /* Stone 900 */
                            card: '#292524',   /* Stone 800 */
                            gold: '#d97706',   /* Amber 600 */
                            goldLight: '#fcd34d', /* Amber 300 */
                            text: '#e7e5e4',   /* Stone 200 */
                            danger: '#7f1d1d'  /* Red 900 */
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0c0a09; color: #e7e5e4; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1c1917; }
        ::-webkit-scrollbar-thumb { background: #57534e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d97706; }

        /* Map Grid System */
        .map-container {
            width: 1024px;   /* Fixed Size ตามโจทย์ */
            height: 1024px;
            position: relative;
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .grid-overlay {
            display: grid;
            width: 100%;
            height: 100%;
            grid-template-columns: repeat(12, 1fr); /* 12 คอลัมน์ */
            grid-template-rows: repeat(12, 1fr);    /* 12 แถว */
        }

        .grid-cell {
            border: 1px solid rgba(255, 255, 255, 0.15); /* เส้นกริดจางๆ */
            position: relative;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .grid-cell:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Hover สีขาวจางๆ */
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Locked Cell Style */
        .grid-cell.locked {
            background-color: rgba(0, 0, 0, 0.85);
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(50, 50, 50, 0.5) 10px,
                rgba(50, 50, 50, 0.5) 20px
            );
            cursor: not-allowed;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Avatar Token */
        .player-token {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 2px solid #d97706;
            background-size: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            margin: auto;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col font-body">

        <div v-if="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-dnd-bg">
            <i class="ph ph-spinner animate-spin text-4xl text-dnd-gold mb-4"></i>
            <p class="text-dnd-gold font-fantasy tracking-widest text-xl">Loading Realm Data...</p>
        </div>

        <div v-if="!loading && currentView === 'landing'" class="container mx-auto px-4 py-10 animate-fade-in">
            <header class="text-center mb-12">
                <h1 class="text-5xl font-fantasy text-dnd-gold drop-shadow-lg mb-2">Adventure Maps</h1>
                <p class="text-stone-500">เลือกสถานที่เพื่อเริ่มสำรวจ</p>
                <div class="h-0.5 w-24 bg-dnd-gold mx-auto mt-4"></div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="map in maps" :key="map.map_id" @click="selectMap(map)"
                     class="group bg-dnd-card border border-stone-700 rounded-lg overflow-hidden cursor-pointer hover:border-dnd-gold transition-all duration-300 hover:shadow-[0_0_15px_rgba(217,119,6,0.2)]">
                    <div class="h-48 overflow-hidden">
                        <img :src="map.image_url" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    </div>
                    <div class="p-5">
                        <h3 class="text-xl font-fantasy text-dnd-gold group-hover:text-dnd-goldLight">{{ map.name }}</h3>
                        <p class="text-stone-400 text-sm mt-2 line-clamp-2">{{ map.description }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="!loading && currentView === 'map'" class="flex-1 flex flex-col h-screen overflow-hidden">
            
            <div class="bg-dnd-dark border-b border-stone-700 p-4 flex justify-between items-center z-20 shadow-lg">
                <button @click="goHome" class="flex items-center text-stone-400 hover:text-dnd-gold transition-colors">
                    <i class="ph ph-arrow-left text-xl mr-2"></i> กลับหน้าหลัก
                </button>
                <h2 class="font-fantasy text-xl text-dnd-gold">{{ selectedMap.name }}</h2>
                <div class="text-sm text-stone-500">Grid 12x12</div>
            </div>

            <div class="flex-1 overflow-auto bg-stone-900 flex justify-center p-4 md:p-10">
                
                <div class="map-container rounded-lg" :style="{ backgroundImage: 'url(' + selectedMap.image_url + ')' }">
                    <div class="grid-overlay">
                        <div v-for="n in 144" :key="n" 
                             class="grid-cell"
                             :class="{ 'locked': isLocked(n) }"
                             @click="handleCellClick(n)">
                            
                            <div v-if="getPlayersInCell(n).length > 0" class="w-full h-full flex items-center justify-center">
                                <img v-if="getPlayersInCell(n).length === 1" 
                                     :src="getPlayersInCell(n)[0].avatar_url" 
                                     class="player-token" 
                                     :title="getPlayersInCell(n)[0].name">
                                
                                <div v-else class="player-token bg-dnd-card flex items-center justify-center text-xs font-bold text-dnd-gold">
                                    {{ getPlayersInCell(n).length }}
                                </div>
                            </div>

                            <i v-if="isLocked(n)" class="ph ph-lock text-stone-500 text-2xl opacity-50"></i>

                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" @click.self="closeModal">
            <div class="bg-dnd-card border border-stone-600 rounded-lg w-full max-w-sm p-6 shadow-2xl transform scale-100 transition-all">
                
                <div class="flex justify-between items-start mb-4">
                    <h3 class="font-fantasy text-xl text-dnd-gold">Cell Info ({{ selectedCell.x }}, {{ selectedCell.y }})</h3>
                    <button @click="closeModal" class="text-stone-400 hover:text-white"><i class="ph ph-x text-xl"></i></button>
                </div>

                <div v-if="selectedCell.locked" class="text-center py-4">
                    <i class="ph ph-lock-key text-4xl text-red-900 mb-2"></i>
                    <p class="text-red-400 font-bold">พื้นที่ถูกปิดกั้น</p>
                    <p class="text-stone-400 text-sm mt-1">{{ selectedCell.lockNote }}</p>
                </div>

                <div v-else-if="selectedCell.players.length > 0">
                    <p class="text-sm text-stone-500 mb-2">ตัวละครในช่องนี้:</p>
                    <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <div v-for="player in selectedCell.players" :key="player.player_id" class="flex items-center bg-stone-900/50 p-2 rounded border border-stone-700">
                            <img :src="player.avatar_url" class="w-10 h-10 rounded-full border border-dnd-gold mr-3 object-cover">
                            <div>
                                <div class="font-bold text-dnd-text">{{ player.name }}</div>
                                <div class="text-xs text-dnd-gold">Player</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="text-center py-6 text-stone-500">
                    <p>ไม่มีสิ่งมีชีวิตในบริเวณนี้</p>
                </div>

            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    // *** 1. ใส่ลิงก์ CSV จาก Google Sheet ตรงนี้ครับ (อย่าลืมเปลี่ยน gid ตามแท็บ) ***
                    urls: {
                        maps: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRTVHgp2VrCC6CVnGH8stpi0-ks7iv3pAo8quYNSHSVxGBZJsc7onNj94pb2Z7DPM5HmKqaC99dF3F5/pub?gid=0&single=true&output=csv',
                        players: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRTVHgp2VrCC6CVnGH8stpi0-ks7iv3pAo8quYNSHSVxGBZJsc7onNj94pb2Z7DPM5HmKqaC99dF3F5/pub?gid=1668031560&single=true&output=csv',
                        locks: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRTVHgp2VrCC6CVnGH8stpi0-ks7iv3pAo8quYNSHSVxGBZJsc7onNj94pb2Z7DPM5HmKqaC99dF3F5/pub?gid=1113843652&single=true&output=csv'
                    },
                    
                    // State
                    loading: true,
                    currentView: 'landing', // 'landing' or 'map'
                    showModal: false,
                    
                    // Data Store
                    maps: [],
                    players: [],
                    locks: [],
                    
                    // Selections
                    selectedMap: null,
                    selectedCell: { x: 0, y: 0, players: [], locked: false, lockNote: '' }
                }
            },
            mounted() {
                this.fetchAllData()
            },
            methods: {
                // โหลดข้อมูลพร้อมกัน 3 แหล่ง
                async fetchAllData() {
                    this.loading = true
                    try {
                        const [mapsRes, playersRes, locksRes] = await Promise.all([
                            fetch(this.urls.maps),
                            fetch(this.urls.players),
                            fetch(this.urls.locks)
                        ])

                        this.maps = this.csvToJson(await mapsRes.text())
                        this.players = this.csvToJson(await playersRes.text())
                        this.locks = this.csvToJson(await locksRes.text())
                        
                    } catch (error) {
                        console.error("Error loading data:", error)
                        alert("เกิดข้อผิดพลาดในการโหลดข้อมูล โปรดตรวจสอบลิงก์ CSV")
                    } finally {
                        this.loading = false
                    }
                },

                // เลือกแผนที่
                selectMap(map) {
                    this.selectedMap = map
                    this.currentView = 'map'
                },

                // กลับหน้าหลัก
                goHome() {
                    this.selectedMap = null
                    this.currentView = 'landing'
                },

                // แปลง Grid Index (1-144) เป็น XY
                indexToXY(n) {
                    // n เริ่มที่ 1
                    const x = ((n - 1) % 12) + 1
                    const y = Math.floor((n - 1) / 12) + 1
                    return { x, y }
                },

                // ตรวจสอบว่าช่องล็อคหรือไม่ (เฉพาะ map ปัจจุบัน)
                isLocked(n) {
                    if (!this.selectedMap) return false
                    const { x, y } = this.indexToXY(n)
                    return this.locks.some(l => 
                        l.map_id === this.selectedMap.map_id && 
                        parseInt(l.pos_x) === x && 
                        parseInt(l.pos_y) === y
                    )
                },

                // ดึงผู้เล่นในช่อง (เฉพาะ map ปัจจุบัน)
                getPlayersInCell(n) {
                    if (!this.selectedMap) return []
                    const { x, y } = this.indexToXY(n)
                    return this.players.filter(p => 
                        p.current_map_id === this.selectedMap.map_id && 
                        parseInt(p.pos_x) === x && 
                        parseInt(p.pos_y) === y
                    )
                },

                // คลิกช่อง
                handleCellClick(n) {
                    const { x, y } = this.indexToXY(n)
                    const players = this.getPlayersInCell(n)
                    
                    // หาข้อมูล Lock
                    const lockData = this.locks.find(l => 
                        l.map_id === this.selectedMap.map_id && 
                        parseInt(l.pos_x) === x && 
                        parseInt(l.pos_y) === y
                    )

                    this.selectedCell = {
                        x, y,
                        players: players,
                        locked: !!lockData,
                        lockNote: lockData ? lockData.note : ''
                    }
                    this.showModal = true
                },

                closeModal() {
                    this.showModal = false
                },

                // CSV Utility (แบบง่าย)
                csvToJson(csvText) {
                    const lines = csvText.trim().split('\n')
                    const headers = lines[0].trim().split(',').map(h => h.trim())
                    return lines.slice(1).map(line => {
                        const values = line.split(',')
                        let obj = {}
                        headers.forEach((h, i) => {
                            obj[h] = values[i] ? values[i].trim() : ''
                        })
                        return obj
                    })
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
